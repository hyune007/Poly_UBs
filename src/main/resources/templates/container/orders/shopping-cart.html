<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{container/orders/order::view(~{::title}, ~{::content})}">
<head>
  <title>Gi·ªè h√†ng</title>
</head>
<body>
<div th:fragment="content">
  <div class="container mb-5">
    <h3 class="text-center mt-4 mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h3>

    <!-- Ki·ªÉm tra gi·ªè h√†ng c√≥ s·∫£n ph·∫©m kh√¥ng -->
    <div th:if="${cartItems == null || cartItems.isEmpty()}" class="text-center py-5">
      <h5 class="text-muted">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</h5>
      <a href="/home" class="btn btn-primary mt-3">Ti·∫øp t·ª•c mua s·∫Øm</a>
    </div>

    <div th:if="${cartItems != null && !cartItems.isEmpty()}" class="row">
      <!-- Danh s√°ch s·∫£n ph·∫©m -->
      <div class="col-lg-8">
        <div class="cart-container">
          <!-- L·∫∑p qua t·ª´ng s·∫£n ph·∫©m trong gi·ªè h√†ng -->
          <div th:each="item : ${cartItems}" class="cart-item d-flex align-items-center mb-4 border-bottom pb-3">
            <img th:src="@{|/photos/${item.product.image}|}" style="height: 80px;width: 80px; object-fit: contain;" alt="S·∫£n ph·∫©m">
            <div class="ms-3 flex-grow-1">
              <h6 class="mb-1" th:text="${item.product.name}">T√™n s·∫£n ph·∫©m</h6>
              <small class="text-muted" th:text="${item.product.brand.name}">Th∆∞∆°ng hi·ªáu</small>
              <br>
              <small class="text-muted">ƒê∆°n gi√°: <span th:text="${#numbers.formatDecimal(item.product.price,0,'COMMA',0,'POINT')}"></span>‚Ç´</small>
            </div>
            <div class="d-flex align-items-center gap-3">
              <input type="number"
                     class="form-control form-control-sm quantity-input"
                     th:value="${item.quantity}"
                     min="1"
                     th:max="${item.product.stock}"
                     th:attr="data-cart-id=${item.id}"
                     onchange="updateQuantity(this)"
                     style="width:70px;">
              <span class="fw-bold price-display" th:text="${#numbers.formatDecimal(item.product.price * item.quantity,0,'COMMA',0,'POINT')} + '‚Ç´'">T·ªïng</span>
              <button class="btn btn-sm btn-danger" th:attr="data-cart-id=${item.id}" onclick="removeFromCart(this)">
                <i class="bi bi-trash"></i> X√≥a
              </button>
            </div>
          </div>

          <a href="/home" class="text-decoration-none">‚Üê Ti·∫øp t·ª•c mua h√†ng</a>
        </div>
      </div>

      <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
      <div class="col-lg-4">
        <div class="cart-summary">
          <h5 class="mb-3">T√≥m t·∫Øt ƒë∆°n h√†ng</h5>
          <div class="d-flex justify-content-between mb-2">
            <span>T·∫°m t√≠nh:</span>
            <strong id="subtotal" th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
            <strong id="shipping">40.000‚Ç´</strong>
          </div>
          <hr>
          <div class="d-flex justify-content-between mb-3">
            <span><strong>T·ªïng c·ªông:</strong></span>
            <strong class="text-danger fs-5" id="total" th:text="${#numbers.formatDecimal(total + 40000,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</strong>
          </div>
          <form action="/order/infor-order" method="get">
            <button type="submit">Ti·∫øn h√†nh ƒë·∫∑t h√†ng</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Script x·ª≠ l√Ω c·∫≠p nh·∫≠t v√† x√≥a s·∫£n ph·∫©m -->
  <script th:inline="javascript">
function updateQuantity(input) {
    const cartId = input.getAttribute('data-cart-id');
    const quantity = input.value;

    if (quantity < 1) {
        alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0');
        input.value = 1;
        return;
    }

    fetch('/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'cartId=' + cartId + '&quantity=' + quantity
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
    });
}

function removeFromCart(button) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?')) {
        return;
    }

    const cartId = button.getAttribute('data-cart-id');

    fetch('/cart/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'cartId=' + cartId
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!');
    });
}
</script>
</div>
</body>
</html>

