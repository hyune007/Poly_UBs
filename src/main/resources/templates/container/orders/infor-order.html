<!DOCTYPE html>
<html th:replace="~{container/orders/order::view(~{::title}, ~{::article})}"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Giới thiệu</title>
</head>
<body>
<div th:replace="container/orders/order-process :: *"></div>
<article>
    <div class="form-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">Thông tin khách mua hàng</h5>
            <button class="btn btn-sm btn-outline-primary" id="editCustomerInfoBtn" type="button">Chỉnh sửa thông tin
            </button>
        </div>

        <form method="post" th:action="@{/order/submit-info}" th:object="${orderInfo}">
            <input id="selectedAddressId" name="addressId" type="hidden"/>

            <div class="row g-3">
                <div class="col-md-6">
                    <input class="form-control" name="fullName" readonly required
                           th:value="${orderInfo.fullName != null ? orderInfo.fullName : customer.name}" type="text"/>
                </div>
                <div class="col-md-6">
                    <input class="form-control" name="phone" readonly required
                           th:value="${orderInfo.phone != null ? orderInfo.phone : customer.phone}" type="tel"/>
                </div>
            </div>

            <hr class="my-4">

            <!-- Địa chỉ mặc định -->
            <div class="form-group">
                <label>Địa chỉ mặc định</label>
                <select class="form-select form-select-sm"
                        id="addressSelect" th:if="${customer.addresses}">
                    <option th:each="addr : ${customer.addresses}"
                            th:selected="${addr.isDefault}"
                            th:text="${addr.fullAddress}"
                            th:value="${addr.id}">
                    </option>
                </select>
                <div class="text-muted small" id="noAddressHint" th:if="${#lists.isEmpty(customer.addresses)}">Chưa có
                    địa chỉ nào, hãy thêm bên dưới.
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" id="addAddressToggleBtn" type="button">+ Thêm địa
                    chỉ
                </button>
            </div>
            <!-- Modal thêm địa chỉ -->
            <div aria-hidden="true" class="modal fade" id="addAddressModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Thêm địa chỉ</h5>
                            <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label">Tỉnh / Thành phố</label>
                                    <select class="form-select form-select-sm" id="provinceSelect">
                                        <option value="">Tỉnh / Thành phố</option>
                                        <option value="ha-noi">TP Hà Nội</option>
                                        <option value="hue">TP Huế</option>
                                        <option value="quang-ninh">Quảng Ninh</option>
                                        <option value="cao-bang">Cao Bằng</option>
                                        <option value="lang-son">Lạng Sơn</option>
                                        <option value="lai-chau">Lai Châu</option>
                                        <option value="dien-bien">Điện Biên</option>
                                        <option value="son-la">Sơn La</option>
                                        <option value="thanh-hoa">Thanh Hóa</option>
                                        <option value="nghe-an">Nghệ An</option>
                                        <option value="ha-tinh">Hà Tĩnh</option>
                                        <option value="tuyen-quang">Tuyên Quang</option>
                                        <option value="lao-cai">Lào Cai</option>
                                        <option value="thai-nguyen">Thái Nguyên</option>
                                        <option value="phu-tho">Phú Thọ</option>
                                        <option value="bac-ninh">Bắc Ninh</option>
                                        <option value="hung-yen">Hưng Yên</option>
                                        <option value="hai-phong">TP Hải Phòng</option>
                                        <option value="ninh-binh">Ninh Bình</option>
                                        <option value="quang-tri">Quảng Trị</option>
                                        <option value="da-nang">TP Đà Nẵng</option>
                                        <option value="quang-ngai">Quảng Ngãi</option>
                                        <option value="gia-lai">Gia Lai</option>
                                        <option value="khanh-hoa">Khánh Hòa</option>
                                        <option value="lam-dong">Lâm Đồng</option>
                                        <option value="dak-lak">Đắk Lắk</option>
                                        <option value="tphcm">TP Hồ Chí Minh</option>
                                        <option value="dong-nai">Đồng Nai</option>
                                        <option value="tay-ninh"></option>
                                        <option value="can-tho">TP Cần Thơ</option>
                                        <option value="vinh-long">Vĩnh Long</option>
                                        <option value="dong-thap">Đồng Tháp</option>
                                        <option value="ca-mau">Cà Mau</option>
                                        <option value="an-giang">An Giang</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Quận/Huyện/Phường</label>
                                    <input class="form-control form-control-sm" id="districtInput"
                                           placeholder="Ví dụ: Cầu Giấy"
                                           type="text">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Số nhà</label>
                                    <input class="form-control form-control-sm" id="houseNumberInput"
                                           placeholder="Ví dụ: 123"
                                           type="text">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tên đường</label>
                                    <input class="form-control form-control-sm" id="streetInput"
                                           placeholder="Ví dụ: Trần Duy Hưng"
                                           type="text">
                                </div>
                            </div>
                            <div class="small mt-2 text-success d-none" id="addressMessage">Lưu thành công!</div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal" id="cancelAddAddressBtn"
                                    type="button">Hủy
                            </button>
                            <button class="btn btn-primary" id="saveAddressBtn" type="button">Lưu địa chỉ</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <textarea class="form-control" placeholder="Lưu ý, yêu cầu khác (Không bắt buộc)" rows="2"
                          th:field="*{note}"></textarea>
            </div>

            <hr>

            <h6>Dịch vụ giao hàng</h6>
            <div class="form-check">
                <input checked class="form-check-input" th:field="*{shippingMethod}" type="radio" value="standard">
                <label class="form-check-label">Giao hàng tiêu chuẩn - 0₫</label>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" th:field="*{shippingMethod}" type="radio" value="pickup">
                <label class="form-check-label">Nhận tại cửa hàng - 0₫</label>
            </div>

            <div class="mb-3">
                <strong>Tạm tính:</strong> <span
                    th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + '₫'">0₫</span> <br>
                <strong>Phí vận chuyển:</strong> 0₫ <br>
                <strong>Tổng tiền:</strong> <span style="color: red; font-size: 18px;"
                                                  th:text="${#numbers.formatDecimal(total,0,'COMMA',0,'POINT')} + '₫'">0₫</span>
            </div>

            <button class="btn btn-primary btn-lg w-100" type="submit">Đặt hàng ngay</button>
            <p class="note mt-2 text-center">Bạn có thể chọn hình thức thanh toán sau khi đặt hàng</p>
        </form>
    </div>
    <script>
        // Script modal thêm địa chỉ
        document.addEventListener('DOMContentLoaded', function () {
            const addressSelect = document.getElementById('addressSelect');
            const addAddressToggleBtn = document.getElementById('addAddressToggleBtn');
            const addAddressModalEl = document.getElementById('addAddressModal');
            const addAddressModal = (addAddressModalEl && window.bootstrap && window.bootstrap.Modal)
                ? new window.bootstrap.Modal(addAddressModalEl)
                : null;
            const saveAddressBtn = document.getElementById('saveAddressBtn');
            const provinceSelect = document.getElementById('provinceSelect');
            const cancelAddAddressBtn = document.getElementById('cancelAddAddressBtn');
            const addressMessage = document.getElementById('addressMessage');
            const hiddenAddress = document.getElementById('selectedAddressId');

            const districtInput = document.getElementById('districtInput');
            const houseNumberInput = document.getElementById('houseNumberInput');
            const streetInput = document.getElementById('streetInput');

            // Logic chỉnh sửa thông tin khách hàng
            const editBtn = document.getElementById('editCustomerInfoBtn');
            const nameInput = document.querySelector('input[name="fullName"]');
            const phoneInput = document.querySelector('input[name="phone"]');

            if (editBtn && nameInput && phoneInput) {
                editBtn.addEventListener('click', function () {
                    const isReadonly = nameInput.hasAttribute('readonly');
                    if (isReadonly) {
                        nameInput.removeAttribute('readonly');
                        phoneInput.removeAttribute('readonly');
                        nameInput.focus();
                        editBtn.textContent = 'Xong';
                        editBtn.classList.remove('btn-outline-primary');
                        editBtn.classList.add('btn-primary');
                    } else {
                        nameInput.setAttribute('readonly', 'true');
                        phoneInput.setAttribute('readonly', 'true');
                        editBtn.textContent = 'Chỉnh sửa thông tin';
                        editBtn.classList.add('btn-outline-primary');
                        editBtn.classList.remove('btn-primary');
                    }
                });
            }

            function setAddAddressInputsEnabled(enabled) {
                if (provinceSelect) provinceSelect.disabled = !enabled;
                if (districtInput) districtInput.disabled = !enabled;
                if (houseNumberInput) houseNumberInput.disabled = !enabled;
                if (streetInput) streetInput.disabled = !enabled;
            }

            // Init: sync hidden address id
            if (addressSelect && hiddenAddress) hiddenAddress.value = addressSelect.value;

            addAddressToggleBtn?.addEventListener('click', () => {
                addressMessage.classList.add('d-none');
                setAddAddressInputsEnabled(true);
                if (addAddressModal) {
                    addAddressModal.show();
                } else if (addAddressModalEl) {
                    addAddressModalEl.classList.add('show');
                    addAddressModalEl.style.display = 'block';
                }
            });

            // Lưu địa chỉ mới
            saveAddressBtn?.addEventListener('click', async () => {
                const province = provinceSelect ? (provinceSelect.options[provinceSelect.selectedIndex]?.text || '').trim() : '';
                const district = districtInput ? districtInput.value.trim() : '';
                const houseNumber = houseNumberInput ? houseNumberInput.value.trim() : '';
                const street = streetInput ? streetInput.value.trim() : '';
                if (!province || !district || !houseNumber || !street) {
                    addressMessage.classList.remove('d-none');
                    addressMessage.classList.replace('text-success', 'text-danger');
                    addressMessage.textContent = 'Vui lòng điền đầy đủ.';
                    return;
                }
                const detailAddress = houseNumber + ' ' + street;
                try {
                    const resp = await fetch('/addresses', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({city: province, ward: district, detailAddress})
                    });
                    if (!resp.ok) throw new Error(await resp.text());
                    const data = await resp.json();
                    if (addressSelect) {
                        const opt = document.createElement('option');
                        opt.value = data.id;
                        opt.textContent = data.fullAddress;
                        addressSelect.appendChild(opt);
                        addressSelect.value = data.id;
                        if (hiddenAddress) hiddenAddress.value = data.id;
                    }
                    addressMessage.classList.remove('d-none');
                    addressMessage.classList.replace('text-danger', 'text-success');
                    addressMessage.textContent = 'Lưu thành công!';
                    if (addAddressModal) {
                        addAddressModal.hide();
                    } else if (addAddressModalEl) {
                        addAddressModalEl.classList.remove('show');
                        addAddressModalEl.style.display = 'none';
                    }
                    setAddAddressInputsEnabled(false);
                    if (provinceSelect) provinceSelect.selectedIndex = 0;
                    [districtInput, houseNumberInput, streetInput].forEach(el => {
                        if (el) el.value = '';
                    });
                } catch (e) {
                    addressMessage.classList.remove('d-none');
                    addressMessage.classList.replace('text-success', 'text-danger');
                    addressMessage.textContent = 'Lỗi: ' + e.message;
                }
            });

            cancelAddAddressBtn?.addEventListener('click', () => {
                setAddAddressInputsEnabled(false);
            });

            // Update default & hidden on change
            addressSelect?.addEventListener('change', async (e) => {
                const id = e.target.value;
                if (hiddenAddress) hiddenAddress.value = id;
                try {
                    const resp = await fetch(`/addresses/${id}/default`, {method: 'PUT'});
                    if (!resp.ok) throw new Error(await resp.text());
                } catch (err) {
                    console.error('Đổi địa chỉ mặc định lỗi:', err);
                }
            });
        });
    </script>
    <!-- Bootstrap JS for modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</article>
</body>
</html>

