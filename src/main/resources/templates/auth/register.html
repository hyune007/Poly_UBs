<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ƒêƒÉng k√Ω - Tech Store</title>
    <link rel="stylesheet" href="/css/general.css">
    <link rel="stylesheet" href="/css/auth/register.css">
</head>
<body>

<!-- üß† N·ªÅn m·∫°ch ƒëi·ªán t·ª≠ -->
<div class="circuit-background"></div>

<!-- ‚¨ÖÔ∏è N√∫t quay l·∫°i -->
<a href="/login" class="back-btn">
    ‚Üê <span>Quay l·∫°i ƒëƒÉng nh·∫≠p</span>
</a>
<script>
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyBrXjvjPcoFM2yw39yfmgjwksohhhs3eDk",
        authDomain: "poly-ubs-java5.firebaseapp.com",
        projectId: "poly-ubs-java5",
        storageBucket: "poly-ubs-java5.firebasestorage.app",
        messagingSenderId: "809642356997",
        appId: "1:809642356997:web:7bbb502520efb38bae076c",
        measurementId: "G-H4VY6C3DE2"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    document.getElementById('googleSignIn').addEventListener('click', async () => {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            const idToken = await user.getIdToken();

            // POST idToken to backend to create session
            const res = await fetch('/sessionLogin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ idToken })
            });

            if (res.ok) {
                // Redirect to home page where Thymeleaf will show info from session
                window.location.href = '/';
            } else {
                const txt = await res.text();
                alert('Login failed: ' + txt);
            }
        } catch (err) {
            console.error(err);
            alert('Sign-in error: ' + err.message);
        }
    });
</script>
<!-- ‚òÅÔ∏è Sinh nhi·ªÅu m√¢y -->
<script>
    function createCloud(top, size, duration, opacity) {
        const cloud = document.createElement("div");
        cloud.classList.add("cloud");
        cloud.style.top = top + "%";
        cloud.style.left = -size + "px";
        cloud.style.width = size + "px";
        cloud.style.height = size / 3 + "px";
        cloud.style.opacity = opacity;
        cloud.style.animationDuration = duration + "s";
        document.body.appendChild(cloud);
    }

    for (let i = 0; i < 10; i++) {
        createCloud(
            Math.random() * 70,
            150 + Math.random() * 250,
            60 + Math.random() * 50,
            0.3 + Math.random() * 0.4
        );
    }
</script>

<!-- üåê Icon c√¥ng ngh·ªá -->
<img src="https://cdn-icons-png.flaticon.com/512/888/888879.png" class="tech-icon" style="top:10%; left:5%;">
<img src="https://cdn-icons-png.flaticon.com/512/1006/1006363.png" class="tech-icon" style="bottom:15%; right:10%;">
<img src="https://cdn-icons-png.flaticon.com/512/4248/4248443.png" class="tech-icon" style="top:20%; right:15%;">
<img src="https://cdn-icons-png.flaticon.com/512/6062/6062646.png" class="tech-icon" style="bottom:10%; left:15%;">


<!-- üíß Form ƒëƒÉng k√Ω -->
<div class="register-container">
    <h2>ƒêƒÉng k√Ω t√†i kho·∫£n</h2>

    <div class="google-btn" id="googleRegisterBtn" style="cursor: pointer;">
        <img src="https://www.svgrepo.com/show/355037/google.svg" alt="Google Logo" style="width: 20px; height: 20px;">
        ƒêƒÉng k√Ω b·∫±ng Google
    </div>

    <div class="divider">ho·∫∑c</div>

    <form action="/register-post" method="post">
        <input type="text" name="name" placeholder="H·ªç v√† t√™n" required>
        <input type="email" name="email" placeholder="Email" required>
        <input type="text" name="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required>
        <input type="password" name="password" placeholder="M·∫≠t kh·∫©u" required>
        <input type="password" name="confirmPassword" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u" required>
        <button class="btn" type="submit">T·∫°o t√†i kho·∫£n</button>
    </form>
    
    <!-- Hi·ªÉn th·ªã th√¥ng b√°o l·ªói n·∫øu c√≥ -->
    <div th:if="${error}" class="alert alert-danger mt-3">
        <p style="color: red; text-align: center;" th:text="${error}"></p>
    </div>
    
    <!-- Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng n·∫øu c√≥ -->
    <div th:if="${success}" class="alert alert-success mt-3">
        <p style="color: green; text-align: center;" th:text="${success}"></p>
    </div>


    <div class="options">
        <p>ƒê√£ c√≥ t√†i kho·∫£n? <a href="/login">ƒêƒÉng nh·∫≠p ngay</a></p>
    </div>
</div>

<!-- ‚ú® ƒê·ªëm tr·∫Øng theo chu·ªôt -->
<script>
    document.addEventListener("mousemove", (e) => {
        for (let i = 0; i < 3; i++) {
            const particle = document.createElement("div");
            particle.classList.add("particle");

            const x = e.pageX + (Math.random() * 20 - 10);
            const y = e.pageY + (Math.random() * 20 - 10);

            particle.style.left = x + "px";
            particle.style.top = y + "px";

            const size = Math.random() * 8 + 4;
            particle.style.width = size + "px";
            particle.style.height = size + "px";

            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
        }
    });
</script>

<!-- Firebase SDK -->
<script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBrXjvjPcoFM2yw39yfmgjwksohhhs3eDk",
        authDomain: "poly-ubs-java5.firebaseapp.com",
        projectId: "poly-ubs-java5",
        storageBucket: "poly-ubs-java5.firebasestorage.app",
        messagingSenderId: "809642356997",
        appId: "1:809642356997:web:7bbb502520efb38bae076c",
        measurementId: "G-H4VY6C3DE2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // X·ª≠ l√Ω ƒëƒÉng k√Ω/ƒëƒÉng nh·∫≠p Google
    document.getElementById('googleRegisterBtn').addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;

            // L·∫•y ID token t·ª´ Firebase
            const idToken = await user.getIdToken();

            // G·ª≠i token ƒë·∫øn backend ƒë·ªÉ x√°c th·ª±c v√† t·∫°o session
            const response = await fetch('/api/auth/firebase-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ idToken: idToken })
            });

            const data = await response.json();

            if (data.success) {
                // ƒêƒÉng k√Ω/ƒëƒÉng nh·∫≠p th√†nh c√¥ng, chuy·ªÉn v·ªÅ trang ch·ªß
                window.location.href = '/home';
            } else {
                alert('ƒêƒÉng k√Ω th·∫•t b·∫°i: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ƒêƒÉng k√Ω Google th·∫•t b·∫°i: ' + error.message);
        }
    });
</script>

</body>
</html>