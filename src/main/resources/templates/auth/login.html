<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>ÄÄƒng nháº­p - Tech Store</title>
    <link href="/css/general.css" rel="stylesheet">
    <link href="/css/auth/login.css" rel="stylesheet">
</head>
<body>

<!-- ğŸ§  Ná»n máº¡ch Ä‘iá»‡n tá»­ -->
<div class="circuit-background"></div>

<!-- â¬…ï¸ NÃºt quay láº¡i -->
<a class="back-btn" href="/home">
    â† <span>Quay láº¡i trang chá»§</span>
</a>

<!-- â˜ï¸ Sinh nhiá»u mÃ¢y -->
<script>
    function createCloud(top, size, duration, opacity) {
        const cloud = document.createElement("div");
        cloud.classList.add("cloud");
        cloud.style.top = top + "%";
        cloud.style.left = -size + "px";
        cloud.style.width = size + "px";
        cloud.style.height = size / 3 + "px";
        cloud.style.opacity = opacity;
        cloud.style.animationDuration = duration + "s";
        document.body.appendChild(cloud);
    }

    for (let i = 0; i < 10; i++) {
        createCloud(
            Math.random() * 70,
            150 + Math.random() * 250,
            60 + Math.random() * 50,
            0.3 + Math.random() * 0.4
        );
    }
</script>

<!-- ğŸŒ Icon cÃ´ng nghá»‡ -->
<img class="tech-icon" src="https://cdn-icons-png.flaticon.com/512/888/888879.png" style="top:10%; left:5%;">
<img class="tech-icon" src="https://cdn-icons-png.flaticon.com/512/1006/1006363.png" style="bottom:15%; right:10%;">
<img class="tech-icon" src="https://cdn-icons-png.flaticon.com/512/4248/4248443.png" style="top:20%; right:15%;">
<img class="tech-icon" src="https://cdn-icons-png.flaticon.com/512/6062/6062646.png" style="bottom:10%; left:15%;">

<!-- ğŸ’§ Form -->
<div class="login-container">
    <h2>ÄÄƒng nháº­p</h2>

    <div class="google-btn" id="googleLoginBtn" style="cursor: pointer;">
        <img alt="Google Logo" src="https://www.svgrepo.com/show/355037/google.svg">
        ÄÄƒng nháº­p vá»›i Google
    </div>

    <div class="divider">hoáº·c</div>

    <form action="/login-post" method="post">
        <input name="email" placeholder="Email" required type="email">
        <input name="password" placeholder="Máº­t kháº©u" required type="password">
        <button class="btn" type="submit">ÄÄƒng nháº­p</button>
    </form>

    <!-- Hiá»ƒn thá»‹ thÃ´ng bÃ¡o lá»—i náº¿u Ä‘Äƒng nháº­p tháº¥t báº¡i -->
    <div class="alert alert-danger mt-3" th:if="${param.error}">
        <p style="color: red; text-align: center;">Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng!</p>
    </div>
    <div class="alert alert-success mt-3" th:if="${param.message}">
        <p style="color: green; text-align: center;">ÄÄƒng kÃ½ thÃ nh cÃ´ng, vui lÃ²ng Ä‘Äƒng nháº­p!</p>
    </div>
    <div class="alert alert-success mt-3" th:if="${param.resetSuccess}">
        <p style="color: green; text-align: center;">Äáº·t láº¡i máº­t kháº©u thÃ nh cÃ´ng! Vui lÃ²ng Ä‘Äƒng nháº­p.</p>
    </div>

    <div class="options">
        <p><a href="/forgot-password">QuÃªn máº­t kháº©u?</a></p>
        <p>ChÆ°a cÃ³ tÃ i khoáº£n? <a href="/register">ÄÄƒng kÃ½ ngay</a></p>
    </div>
</div>

<!-- âœ¨ Äá»‘m tráº¯ng theo chuá»™t -->
<script>
    document.addEventListener("mousemove", (e) => {
        for (let i = 0; i < 3; i++) {
            const particle = document.createElement("div");
            particle.classList.add("particle");

            const x = e.pageX + (Math.random() * 20 - 10);
            const y = e.pageY + (Math.random() * 20 - 10);

            particle.style.left = x + "px";
            particle.style.top = y + "px";

            const size = Math.random() * 8 + 4;
            particle.style.width = size + "px";
            particle.style.height = size + "px";

            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 2000);
        }
    });
</script>

<!-- Firebase SDK -->
<script type="module">
    // Import Firebase modules
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Load Firebase configuration tá»« backend
    const configResponse = await fetch('/api/config/firebase');
    const firebaseConfig = await configResponse.json();

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Xá»­ lÃ½ Ä‘Äƒng nháº­p Google
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;

            // Láº¥y ID token tá»« Firebase
            const idToken = await user.getIdToken();

            // Gá»­i token Ä‘áº¿n backend Ä‘á»ƒ xÃ¡c thá»±c vÃ  táº¡o session
            const response = await fetch('/api/auth/firebase-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({idToken: idToken})
            });

            const data = await response.json();

            if (data.success) {
                // ÄÄƒng nháº­p thÃ nh cÃ´ng, chuyá»ƒn vá» trang chá»§
                window.location.href = '/home';
            } else {
                alert('ÄÄƒng nháº­p tháº¥t báº¡i: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ÄÄƒng nháº­p Google tháº¥t báº¡i: ' + error.message);
        }
    });
</script>

</body>
</html>